---
bundle_root: null
ckpt_path: "$@bundle_root + '/model_fold' + str(@fold)"
data_file_base_dir: null
data_list_file_path: null
fold: 0

transforms:
  resample_to_spacing: "$@training#resample_to_spacing"
  lazy_resampling: true

cache_rate: 0
train_cache_rate: "$@cache_rate"
validate_cache_rate: "$@cache_rate"
show_cache_progress: false

training:
  # hyper-parameters
  amp: true
  input_channels: null
  learning_rate: 0.0001
  log_output_file: "$@bundle_root + '/model_fold' + str(@fold) + '/training.log'"
  num_images_per_batch: 1 #2
  num_epochs: 1 # 200
  num_epochs_per_validation: 1 #2
  num_patches_per_image: 1 #4
  num_patches_per_iter: 2
  num_sw_batch_size: "$@training#num_patches_per_iter"
  num_workers: 2 #8
  num_cache_workers: 2 #8
  output_classes: null
  overlap_ratio: 0.625
  patch_size: null
  patch_size_valid: null
  random_seed: 0
  resample_to_spacing: null
  sw_input_on_cpu: false
  softmax: true
  use_pretrain: false
  pretrained_path: $@bundle_root + '/pretrained_model' + '/swin_unetr.base_5000ep_f48_lr2e-4_pretrained.pt'
  adapt_valid_mode: true
  adapt_valid_progress_percentages: [10, 40, 70]
  adapt_valid_num_epochs_per_validation: [2, 4, 2]

  early_stop_mode: true
  early_stop_delta: 0
  early_stop_patience: 20

  loss:
    _target_: DiceFocalLoss
    include_background: true
    to_onehot_y: "$@training#softmax"
    softmax: "$@training#softmax"
    sigmoid: "$not @training#softmax"
    squared_pred: true
    batch: true
    smooth_nr: 1.0e-05
    smooth_dr: 1.0e-05
  optimizer:
    _target_: torch.optim.AdamW
    lr: "@training#learning_rate"
    weight_decay: 1.0e-05
  lr_scheduler:
    _target_: monai.optimizers.WarmupCosineSchedule
    optimizer: "$@training#optimizer"
    warmup_steps: $@training#num_epochs//20
    t_total: '$@training#num_epochs // @training#num_epochs_per_validation + 1'

# fine-tuning
finetune:
  activate: false
  pretrained_ckpt_name: "$@bundle_root + '/model_fold' + str(@fold) + '/best_metric_model.pt'"

# validation
validate:
  ckpt_name: "$@bundle_root + '/model_fold' + str(@fold) + '/best_metric_model.pt'"
  save_mask: true
  output_path: "$@bundle_root + '/prediction_fold' + str(@fold)"

# inference
infer:
  ckpt_name: "$@bundle_root + '/model_fold' + str(@fold) + '/best_metric_model.pt'"
  fast: false
  data_list_key: testing
  output_path: "$@bundle_root + '/prediction_' + @infer#data_list_key"